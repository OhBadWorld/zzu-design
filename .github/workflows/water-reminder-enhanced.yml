name: Smart Water Reminder

on:
  push:
    #branches:
    # - main # ä»…åœ¨è¯¥åˆ†æ”¯æ¨é€æ—¶è§¦å‘
  schedule:
    # å·¥ä½œæ—¥ 9:00-18:00 æ¯å°æ—¶æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ 17:00-02:00ï¼Œéœ€è¦è°ƒæ•´ï¼‰
    # å°è¯•æå‰5åˆ†é’Ÿè§¦å‘ é’ˆå¯¹åŒ—äº¬æ—¶é—´ 9:00-18:00 çš„cronè¡¨è¾¾å¼ï¼š
    - cron: '55 0,1,2,3,4,5,6,7,8,9,10 * * 1-5' # UTCæ—¶é—´ 1:00-10:00 = åŒ—äº¬æ—¶é—´ 9:00-18:00
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  water-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # è®¾ç½®ç¯å¢ƒå˜é‡ HOUR ä¸ºå½“å‰å°æ—¶ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
      - name: Set HOUR environment variable
        run: echo "HOUR=$(date +%H)" >> $GITHUB_ENV

      - name: Send reminder to WeChat
        run: |
          # å¼ºåˆ¶æŒ‰åè¿›åˆ¶è§£æ HOURï¼Œé¿å…å…«è¿›åˆ¶é—®é¢˜
          HOUR=$(date +%H)
          HOUR=$((10#$HOUR))

          # è·å–å½“å‰å°æ—¶ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼Œå¹¶åœ¨éå·¥ä½œæ—¶é—´æå‰é€€å‡º
          if [[ "${GITHUB_EVENT_NAME}" != "schedule" ]]; then
            if [[ "$HOUR" -lt 9 || "$HOUR" -gt 18 ]]; then
              echo "å½“å‰ä¸æ˜¯å·¥ä½œæ—¶é—´ï¼ˆ09-18ï¼‰ï¼Œæ— éœ€æé†’ï¼Œæå‰é€€å‡ºã€‚"
              exit 0
            fi
          fi

          # æ ¹æ®ä¸åŒæ—¶æ®µç”Ÿæˆä¸åŒçš„æé†’æ¶ˆæ¯
          case $HOUR in
            "09") MESSAGE=" ğŸŒ æ—©å®‰å–æ°´æ—¶é—´ï¼\n ğŸ”› å¼€å¯æ–°çš„ä¸€å¤©ï¼Œä»ä¸€æ¯æ¸©æ°´å¼€å§‹ï½" ;;
            "12") MESSAGE=" ğŸ± åˆé—´å–æ°´æ—¶é—´ï¼\n ğŸ¥£ åˆé¤ååŠå°æ—¶ï¼Œå–æ¯æ°´åŠ©æ¶ˆåŒ–ï½" ;;
            "17") MESSAGE=" ğŸŒ‡ å‚æ™šå–æ°´æ—¶é—´ï¼\n â›½ï¸ è¡¥å……æ°´åˆ†ï¼Œä¸ºä¸‹ç­å‰çš„å†²åˆºåŠ æ²¹ï¼" ;;
            *) MESSAGE="ğŸµ å–æ°´æ—¶é—´åˆ°ï¼\n ğŸ’¼ å·¥ä½œè¾›è‹¦äº†ï¼Œè®°å¾—è¡¥å……æ°´åˆ†å“¦ï½" ;;
          esac

          # è®¡ç®—å·²å®Œæˆæ¯æ•°ï¼ˆä»… 09-18 ç‚¹æœ‰æ•ˆï¼Œå¦åˆ™ä¸º 0ï¼‰
          if [[ $HOUR -ge 9 && $HOUR -le 18 ]]; then
            COMPLETED=$((10#$HOUR - 8))
          else
            COMPLETED=0
            MESSAGE="ğŸŒ™ **å½“å‰éå–æ°´æ—¶æ®µ**\n> å·¥ä½œæ—¶é—´ï¼ˆ9:00-18:00ï¼‰æ¯å°æ—¶æé†’å–æ°´å“¦ï½"
          fi

          # å‘é€è¯·æ±‚åˆ°ä¼ä¸šå¾®ä¿¡
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"msgtype\": \"text\",
              \"text\": {
                \"content\": \"$MESSAGE\n\n â° æé†’æ—¶é—´: $(date '+%H:%M')\n ğŸµ ä»Šæ—¥å°ç›®æ ‡: 8æ¯æ°´å·²å®Œæˆ $COMPLETED/8æ¯\",
                \"mentioned_list\": [\" @all\"]
              },
            }" \
            ${{ secrets.WECHAT_WEBHOOK_URL }}