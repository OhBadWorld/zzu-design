name: Smart Water Reminder

on:
  push:
    branches:
      - main
  schedule:
    # 工作日 9:30-19:00 每小时执行（UTC 时间 1:30-11:30）
    # 注意：GitHub Actions 使用 UTC 时间，需要转换为北京时间
    - cron: '30 1-11 * * 1-5'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai

jobs:
  water-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Send reminder to WeChat
        env:
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          TZ: Asia/Shanghai
        run: |
          # 直接使用环境变量TZ获取当前北京时间，确保所有时间命令都使用正确时区
          CURRENT_TIME=$(date '+%H:%M')
          HOUR=$(date '+%H')
          HOUR=$((10#$HOUR))

          # 严格限制工作时间（9:00-19:00），对所有触发方式生效
          # 9:30开始提醒，所以9点这个小时也需要包含在内
          if [[ "$HOUR" -lt 9 || "$HOUR" -gt 19 ]]; then
            echo "当前不是工作时间，退出。"
            exit 0
          fi

          # 时段消息
          case $HOUR in
            9) MESSAGE=🌞 早安喝水时间！\n🔛 开启新的一天，从一杯温水开始～';;
            12) MESSAGE=🍱 午间喝水时间！\n🥣 午餐后半小时，喝杯水健脾开胃～';;
            17) MESSAGE=🌇 傍晚喝水时间！\n⛽️ 补充水分，为下班前的冲刺加油！';;
            19) MESSAGE=🌙 晚间喝水提醒！\n💧 下班前记得喝最后一杯水哦～';;
            *) MESSAGE=🍵 喝水时间到！\n💪 工作辛苦了，记得补充水分哦～';;
          esac

          # 计算杯数，确保结果在1-10之间（9:30到19:00共10个时间段）
          COMPLETED=$((HOUR - 8))
          # 确保杯数不会超过10杯
          [[ $COMPLETED -gt 10 ]] && COMPLETED=10
          # 确保杯数不会为负数
          [[ $COMPLETED -lt 1 ]] && COMPLETED=1

          # 组装内容
          CONTENT="${MESSAGE}"\n\n'"⏰ 提醒时间: ${CURRENT_TIME}"\n'"🍵 今日小目标: 10杯水已完成 ${COMPLETED}/10杯"

          # JSON 构造
          JSON=$(jq -nc --arg text "$CONTENT" '{"msgtype":"text","text":{"content":$text,"mentioned_list":["@all"]}}')

          # 发送
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            "$WECHAT_WEBHOOK_URL"