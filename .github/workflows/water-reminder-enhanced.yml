name: Smart Water Reminder

on:
  push:
    branches:
      - main
  schedule:
    # 工作日 9:30-19:00 每小时执行（UTC 时间 1:30-11:30）
    # 注意：GitHub Actions 使用 UTC 时间，需要转换为北京时间
    # 北京时间 9:30 = UTC 时间 1:30
    - cron: '30 1-11 * * 1-5'
  workflow_dispatch:

jobs:
  water-reminder:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Send reminder to WeChat
        env:
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
        run: |
          # 显式设置TZ环境变量，确保所有时间命令都使用北京时间
          export TZ=Asia/Shanghai
          
          # 获取当前北京时间，精确到分钟
          CURRENT_TIME=$(date '+%H:%M')
          # 获取当前小时数，用于判断时段和计算杯数
          HOUR=$(date '+%H')
          # 强制十进制解析，防止08、09被当作八进制
          HOUR=$((10#$HOUR))
          
          echo "Debug: 当前北京时间: ${CURRENT_TIME}, 小时: ${HOUR}"

          # 严格限制工作时间（9:00-19:00），对所有触发方式生效
          if [[ "$HOUR" -lt 9 || "$HOUR" -gt 19 ]]; then
            echo "当前不是工作时间，退出。"
            exit 0
          fi

          # 时段消息 - 使用$'...'语法确保换行符正确解析
          case $HOUR in
            9) MESSAGE=$'🌞 早安喝水时间！\n🔛 开启新的一天，从一杯温水开始～';;
            12) MESSAGE=$'🍱 午间喝水时间！\n🥣 午餐后半小时，喝杯水健脾开胃～';;
            17) MESSAGE=$'🌇 傍晚喝水时间！\n⛽️ 补充水分，为下班前的冲刺加油！';;
            19) MESSAGE=$'🌙 晚间喝水提醒！\n💧 下班前记得喝最后一杯水哦～';;
            *) MESSAGE=$'🍵 喝水时间到！\n💪 工作辛苦了，记得补充水分哦～';;
          esac

          # 计算杯数，基于实际触发次数（9:30开始每小时1次，目标8杯）
          # 9:30 -> 1杯, 10:30 -> 2杯, ..., 16:30 -> 8杯
          COMPLETED=$((HOUR - 8))
          # 确保杯数不会超过目标8杯
          [[ $COMPLETED -gt 8 ]] && COMPLETED=8
          # 确保杯数不会为负数
          [[ $COMPLETED -lt 1 ]] && COMPLETED=1

          # 组装内容 - 使用$'...'语法确保换行符正确解析
          CONTENT="${MESSAGE}"$'\n\n'"⏰ 提醒时间: ${CURRENT_TIME}"$'\n'"🍵 今日小目标: 8杯水已完成 ${COMPLETED}/8杯"
          
          # 发送企业微信消息
          curl "${WECHAT_WEBHOOK_URL}" \
            -H "Content-Type: application/json" \
            -d "{\"msgtype\": \"text\", \"text\": {\"content\": \"${CONTENT}\"}}"